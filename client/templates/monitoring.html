{% extends "base.html" %}

{% block title %}Monitoring - Event Stream Engine{% endblock %}

{% block content %}
<div class="card">
    <h2>ğŸ“ˆ Campaign Performance Summary</h2>
    {% if campaign_summaries %}
        <div class="stats-grid">
            {% for summary in campaign_summaries %}
            <div class="stat-card" style="text-align: left; border-left-color: 
                {% if summary.campaign_status == 'COMPLETED' %}#28a745{% endif %}
                {% if summary.campaign_status == 'RUNNING' %}#17a2b8{% endif %}
                {% if summary.campaign_status == 'READY' %}#ffc107{% endif %}
                {% if summary.campaign_status == 'DRAFT' %}#6c757d{% endif %}
            ;">
                <h4>{{ summary.campaign_topic }}</h4>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 14px;">
                    <div>
                        <strong>ğŸ“¤ Sent:</strong> {{ summary.messages_sent }}<br>
                        <strong>âœ… Delivered:</strong> {{ summary.messages_delivered }}<br>
                        <strong>âŒ Failed:</strong> {{ summary.messages_failed }}
                    </div>
                    <div>
                        <strong>ğŸ“Š Success Rate:</strong> {{ "%.1f" | format(summary.success_rate_percent) }}%<br>
                        <strong>ğŸ¯ Delivery Rate:</strong> {{ "%.1f" | format(summary.delivery_rate_percent) }}%<br>
                        <strong>ğŸ“‹ Status:</strong> <span class="status status-{{ summary.campaign_status.lower() }}">{{ summary.campaign_status }}</span>
                    </div>
                </div>
                <div style="margin-top: 10px;">
                    <a href="{{ url_for('ui.campaign_summary', campaign_id=summary.campaign_id) }}" 
                       class="btn btn-info" style="padding: 4px 8px; font-size: 12px;">
                        ğŸ“Š View Details
                    </a>
                </div>
            </div>
            {% endfor %}
        </div>
    {% else %}
        <div class="alert alert-info">
            <strong>No campaign summaries available.</strong> Launch some campaigns to see performance data.
        </div>
    {% endif %}
</div>

<div class="card">
    <h2>ğŸ“¨ Recent Inbound Messages</h2>
    <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 15px;">
        <div>
            <strong>Auto-refresh:</strong> 
            <label style="margin-left: 10px;">
                <input type="checkbox" id="auto-refresh" checked> Enable (30s intervals)
            </label>
        </div>
        <div>
            <button onclick="refreshInbound()" class="btn btn-info" style="padding: 6px 12px; font-size: 12px;">
                ğŸ”„ Refresh Now
            </button>
        </div>
    </div>
    
    <div id="inbound-container">
        {% if inbound_events %}
            <table class="table" id="inbound-table">
                <thead>
                    <tr>
                        <th>Time</th>
                        <th>From</th>
                        <th>Message</th>
                        <th>Channel</th>
                        <th>Provider ID</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                    {% for event in inbound_events %}
                                        <tr>
                        <td>{{ event.received_at.strftime('%H:%M:%S') if event.received_at else 'N/A' }}</td>
                        <td>
                            <code style="font-family: monospace; background: #f8f9fa; padding: 2px 6px; border-radius: 3px;">
                                {{ event.masked_phone if event.masked_phone else '****' }}
                            </code>
                        </td>
                        <td style="max-width: 200px;">
                            {% set msg_class = event.message_classification or 'Text Reply' %}
                            <span class="status 
                                {%- if 'STOP' in msg_class %} status-failed
                                {%- elif 'Media' in msg_class %} status-info
                                {%- else %} status-delivered
                                {%- endif %}">
                                {{ msg_class }}
                            </span>
                            {% if 'STOP' in msg_class %}
                                <small style="color: #dc3545; display: block; margin-top: 2px;">â†’ User Opted Out</small>
                            {% endif %}
                        </td>
                        <td>
                            <span class="status status-delivered">{{ event.channel_type.upper() }}</span>
                        </td>
                        <td>
                            <span style="font-size: 11px; color: #28a745;">âœ… Webhook</span>
                        </td>
                        <td>
                            <span class="status status-delivered">âœ… Processed</span>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            
            <div style="margin-top: 15px; padding: 10px; background: #f8f9fa; border-radius: 8px;">
                <strong>ğŸ“Š Inbound Summary:</strong> 
                {{ inbound_events|length }} messages in last 24 hours
                {% if inbound_events|length >= 50 %}
                    (showing most recent 50)
                {% endif %}
            </div>
        {% else %}
            <div class="alert alert-info">
                <strong>No recent inbound messages.</strong> Inbound messages will appear here when users reply to your campaigns.
            </div>
        {% endif %}
    </div>
</div>

<div class="card">
    <h2>ğŸ” Message Analysis</h2>
    {% if inbound_events %}
        {% set stop_commands = inbound_events | selectattr('message_classification', 'defined') | selectattr('message_classification', 'containing', 'STOP') | list %}
        {% set media_messages = inbound_events | selectattr('message_classification', 'defined') | selectattr('message_classification', 'containing', 'Media') | list %}
        
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-number">{{ inbound_events|length }}</div>
                <div class="stat-label">Total Messages</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">{{ metrics.opted_out_users if metrics else 0 }}</div>
                <div class="stat-label">Opt-out Requests</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">{{ media_messages|length }}</div>
                <div class="stat-label">Media Messages</div>
            </div>
            <div class="stat-card">
                <div class="stat-number">{{ (inbound_events|length - stop_commands|length - media_messages|length) }}</div>
                <div class="stat-label">Regular Replies</div>
            </div>
        </div>
        
        {% if stop_commands %}
        <div class="alert alert-info">
            <strong>ğŸ“¢ Compliance Alert:</strong> {{ stop_commands|length }} users have requested to opt out. 
            These have been automatically processed by our compliance engine.
        </div>
        {% endif %}
    {% endif %}
</div>

<div class="card">
    <h2>ğŸš¦ System Health Monitor</h2>
    <div id="health-monitor" data-auto-refresh="15">
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-number" id="celery-status">âœ…</div>
                <div class="stat-label">Celery Workers</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="redis-status">âœ…</div>
                <div class="stat-label">Redis Cache</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="db-status">âœ…</div>
                <div class="stat-label">Database</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="twilio-status">âœ…</div>
                <div class="stat-label">Twilio API</div>
            </div>
        </div>
    </div>
</div>

<div class="card">
    <h2>ğŸ”— API Monitoring Tools</h2>
    <div style="display: flex; gap: 15px; flex-wrap: wrap;">
        <a href="/api/v1/monitoring/dashboard" target="_blank" class="btn btn-info">ğŸ“Š Dashboard API</a>
        <a href="/api/v1/monitoring/inbound" target="_blank" class="btn btn-info">ğŸ“¨ Inbound API</a>
        <a href="/health" target="_blank" class="btn btn-success">ğŸ’š Health Check</a>
        <a href="/api/v1/tasks/status" target="_blank" class="btn btn-info">âš™ï¸ Task Status</a>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let refreshInterval;
    
    // Auto-refresh functionality
    function setupAutoRefresh() {
        const checkbox = document.getElementById('auto-refresh');
        
        function startRefresh() {
            if (refreshInterval) clearInterval(refreshInterval);
            refreshInterval = setInterval(refreshInbound, 30000);
        }
        
        function stopRefresh() {
            if (refreshInterval) clearInterval(refreshInterval);
        }
        
        checkbox.addEventListener('change', function() {
            if (this.checked) {
                startRefresh();
                window.app.showAlert('âœ… Auto-refresh enabled (30s)', 'success');
            } else {
                stopRefresh();
                window.app.showAlert('â¸ï¸ Auto-refresh disabled', 'info');
            }
        });
        
        // Start auto-refresh if checkbox is checked
        if (checkbox.checked) {
            startRefresh();
        }
    }
    
    // Refresh inbound messages
    async function refreshInbound() {
        try {
            const response = await fetch('/api/v1/monitoring/inbound?limit=50');
            const data = await response.json();
            
            if (response.ok && data.events) {
                updateInboundTable(data.events);
                console.log('Inbound messages refreshed:', data.events.length, 'events');
            }
        } catch (error) {
            console.error('Failed to refresh inbound messages:', error);
        }
    }
    
    // Update inbound table with new data
    function updateInboundTable(events) {
        const container = document.getElementById('inbound-container');
        
        if (events.length === 0) {
            container.innerHTML = `
                <div class="alert alert-info">
                    <strong>No recent inbound messages.</strong> Inbound messages will appear here when users reply to your campaigns.
                </div>
            `;
            return;
        }
        
        let tableHTML = `
            <table class="table" id="inbound-table">
                <thead>
                    <tr>
                        <th>Time</th>
                        <th>From</th>
                        <th>Message Type</th>
                        <th>Channel</th>
                        <th>Processing</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
        `;
        
        events.forEach(event => {
            const receivedTime = new Date(event.received_at).toLocaleTimeString();
            const messageClass = event.message_classification || 'Text Reply';
            const isStopCommand = messageClass.includes('STOP');
            const statusClass = isStopCommand ? 'status-failed' : 
                              messageClass.includes('Media') ? 'status-info' : 'status-delivered';
            
            tableHTML += `
                <tr>
                    <td>${receivedTime}</td>
                    <td>
                        <code style="font-family: monospace; background: #f8f9fa; padding: 2px 6px; border-radius: 3px;">
                            ${event.masked_phone || '****'}
                        </code>
                    </td>
                    <td style="max-width: 200px;">
                        <span class="status ${statusClass}">${messageClass}</span>
                        ${isStopCommand ? '<small style="color: #dc3545; display: block; margin-top: 2px;">â†’ User Opted Out</small>' : ''}
                    </td>
                    <td>
                        <span class="status status-delivered">${event.channel_type.toUpperCase()}</span>
                    </td>
                    <td>
                        <span style="font-size: 11px; color: #28a745;">âœ… Webhook</span>
                    </td>
                    <td>
                        <span class="status status-delivered">âœ… Processed</span>
                    </td>
                </tr>
            `;
        });
        
        tableHTML += `
                </tbody>
            </table>
            <div style="margin-top: 15px; padding: 10px; background: #f8f9fa; border-radius: 8px;">
                <strong>ğŸ“Š Inbound Summary:</strong> 
                ${events.length} messages in last 24 hours
                ${events.length >= 50 ? '(showing most recent 50)' : ''}
            </div>
        `;
        
        container.innerHTML = tableHTML;
    }
    
    // Health monitoring
    async function checkSystemHealth() {
        try {
            // Check main health endpoint
            const healthResponse = await fetch('/health');
            const healthData = await healthResponse.json();
            
            // Update health indicators
            document.getElementById('celery-status').textContent = healthData.status === 'healthy' ? 'âœ…' : 'âŒ';
            document.getElementById('db-status').textContent = healthData.status === 'healthy' ? 'âœ…' : 'âŒ';
            
            // Check Redis via dashboard API
            const dashboardResponse = await fetch('/api/v1/monitoring/dashboard');
            if (dashboardResponse.ok) {
                document.getElementById('redis-status').textContent = 'âœ…';
                document.getElementById('twilio-status').textContent = 'âœ…';
            } else {
                document.getElementById('redis-status').textContent = 'âŒ';
                document.getElementById('twilio-status').textContent = 'âŒ';
            }
            
        } catch (error) {
            console.error('Health check failed:', error);
            // Set all to error state
            ['celery-status', 'redis-status', 'db-status', 'twilio-status'].forEach(id => {
                document.getElementById(id).textContent = 'âŒ';
            });
        }
    }
    
    // Initialize monitoring
    document.addEventListener('DOMContentLoaded', function() {
        setupAutoRefresh();
        checkSystemHealth();
        
        // Health check every 15 seconds
        setInterval(checkSystemHealth, 15000);
    });
</script>
{% endblock %}